
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>security Secure PVAccess &#8212; PVXS 1.3.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=12dfc556" />
    <script src="_static/documentation_options.js?v=bb516dca"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="_static/favicon.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="security AuthN &amp; AuthZ" href="spvaauth.html" />
    <link rel="prev" title="developer_guide Quick Start LDAP" href="spvaqstartldap.html" />

   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Material Symbols Outlined -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<!-- Inject extra CSS for pages starting with 'spva' -->
<link rel="stylesheet" type="text/css" href="_static/style.css" />


  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="security-secure-pvaccess">
<span id="secure-pvaccess"></span><h1><i class="material-symbols-outlined" style="vertical-align: middle;">security</i> Secure PVAccess<a class="headerlink" href="#security-secure-pvaccess" title="Link to this heading">¶</a></h1>
<p>Secure PVAccess (SPVA) enhances the existing PVAccess protocol by integrating <a class="reference internal" href="#transport-layer-security"><span class="std std-ref">Transport Layer Security</span></a> (TLS)
with comprehensive <a class="reference internal" href="spvacerts.html#certificate-management"><span class="std std-ref"> Cert Management</span></a>, enabling encrypted communication channels and authenticated connections
between EPICS clients and servers (EPICS agents) - see <a class="reference internal" href="spvaauth.html#authn-and-authz"><span class="std std-ref"> AuthN &amp; AuthZ</span></a>.</p>
<p>For a glossary of terms see: <a class="reference internal" href="spvaglossary.html#glossary"><span class="std std-ref"> SPVA Glossary</span></a></p>
<p>Key Features:</p>
<ul class="simple">
<li><p>Encrypted communication using <code class="docutils literal notranslate"><span class="pre">TLS</span> <span class="pre">1.3</span></code></p></li>
<li><p>Certificate-based authentication</p></li>
<li><p>Comprehensive certificate lifecycle management</p></li>
<li><p>Backward compatibility with existing PVAccess deployments</p></li>
<li><p>Integration with site authentication systems</p></li>
</ul>
<p>Note: This release requires specific unmerged changes to epics-base.</p>
<p>See <a class="reference internal" href="spvaqstart.html#quick-start"><span class="std std-ref"> Quick Start PVXS</span></a> to get started.</p>
<section id="transport-layer-security">
<span id="id1"></span><h2>Transport Layer Security<a class="headerlink" href="#transport-layer-security" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">SPVA</span></code> uses <code class="docutils literal notranslate"><span class="pre">TLS</span> <span class="pre">1.3</span></code> to establish secure connections between EPICS agents. Both client and server
can authenticate their peer using <code class="docutils literal notranslate"><span class="pre">X.509</span></code> certificates. Key features of the TLS implementation:</p>
<ul class="simple">
<li><p>Mutual authentication when both peers present valid certificates</p></li>
<li><p>Server-only authentication when only the server presents a certificate</p></li>
<li><p>Fallback to <code class="docutils literal notranslate"><span class="pre">TCP</span></code> when <code class="docutils literal notranslate"><span class="pre">TLS</span></code> is not configured or certificates are invalid</p></li>
<li><p>Certificate status verification during connection establishment</p></li>
</ul>
<section id="supported-keychain-file-formats-encodings-and-file-types">
<h3>Supported Keychain-File Formats, Encodings and File Types<a class="headerlink" href="#supported-keychain-file-formats-encodings-and-file-types" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>File Type</p></th>
<th class="head"><p>Extension</p></th>
<th class="head"><p>Encoding</p></th>
<th class="head"><p>Includes Private Key?</p></th>
<th class="head"><p>Includes Certificate Chain?</p></th>
<th class="head"><p>Common Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">PKCS#12</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">.p12</span></code>, <code class="docutils literal notranslate"><span class="pre">.pfx</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Binary</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Optional (password)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Yes</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Distributing cert key</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>To use any of these formats just use the appropriate file extension when specifying the keychain file.</p>
</section>
<section id="unsupported-certificate-formats-encodings-and-file-types">
<h3>Unsupported Certificate Formats, Encodings and File Types<a class="headerlink" href="#unsupported-certificate-formats-encodings-and-file-types" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>File Type</p></th>
<th class="head"><p>Extension</p></th>
<th class="head"><p>Encoding</p></th>
<th class="head"><p>Includes Private Key?</p></th>
<th class="head"><p>Includes Certificate Chain?</p></th>
<th class="head"><p>Common Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">PEM</div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">.pem</span></code>, <code class="docutils literal notranslate"><span class="pre">.crt</span></code>,</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">.cer</span></code>, <code class="docutils literal notranslate"><span class="pre">.key</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Base64</div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Optional</div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Optional (concatenated)</div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Web servers, OpenSSL</div>
<div class="line"><br /></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">JKS</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">.jks</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">Binary</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Optional</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Yes</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Java applications</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="tls-encapsulation-of-the-pvaccess-protocol">
<h3>TLS encapsulation of the PVAccess protocol<a class="headerlink" href="#tls-encapsulation-of-the-pvaccess-protocol" title="Link to this heading">¶</a></h3>
<p>In network protocols, encapsulation is used to transport a higher layer protocol over a lower layer protocol, e.g., <code class="docutils literal notranslate"><span class="pre">TCP</span></code> over <code class="docutils literal notranslate"><span class="pre">IP</span></code>.
In the context of TLS, PVAccess messages are encapsulated within <code class="docutils literal notranslate"><span class="pre">TLS</span></code> records for secure transport.</p>
<p>Encapsulation involves wrapping the higher-layer protocol’s data within the lower-layer protocol’s format.
TLS is so named because it wraps all data above the <code class="docutils literal notranslate"><span class="pre">Transport</span> <span class="pre">Layer</span></code> in an impermeable <code class="docutils literal notranslate"><span class="pre">Security</span></code> layer.
For SPVA, this means PVAccess messages are wrapped in TLS records that include headers specifying
content type, protocol version, and length, followed by the encrypted PVAccess data as the payload.</p>
<img alt="TLS Encapsulation of PVAccess" class="align-center" src="_images/pvaencapsulation.png" />
<p>Note: We use <code class="docutils literal notranslate"><span class="pre">TLS</span> <span class="pre">version</span> <span class="pre">1.3</span></code> for Secure PVAccess. This version deprecates support for connection renegotiation which is a security risk. So any
connections that are established using Secure PVAccess will not be renegotiated but will be closed if a certificate is revoked or needs to be renewed</p>
</section>
<section id="environment-variables">
<span id="id2"></span><h3>Environment Variables<a class="headerlink" href="#environment-variables" title="Link to this heading">¶</a></h3>
<p>The following environment variables control SPVA behavior:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is an implied hierarchy to the applicability of the environment variables such that
the PVAS version supersedes a PVA version.
So, if an EPICS server agent wants to specify its keychain file location it can simply
provide the <code class="docutils literal notranslate"><span class="pre">EPICS_PVA_TLS_KEYCHAIN</span></code> environment variable as long as
<code class="docutils literal notranslate"><span class="pre">EPICS_PVAS_TLS_KEYCHAIN</span></code> is not configured.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Key</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>EPICS_PVA_CERT_PV_PREFIX</p></td>
<td colspan="2"><p>{string prefix for certificate management PVs}
e.g. <code class="docutils literal notranslate"><span class="pre">ORNL_CERTS</span></code></p></td>
<td><p>This replaces the default <code class="docutils literal notranslate"><span class="pre">CERT</span></code> prefix.  Followed by
<code class="docutils literal notranslate"><span class="pre">:STATUS:...</span></code>, <code class="docutils literal notranslate"><span class="pre">:ROOT</span></code>, or <code class="docutils literal notranslate"><span class="pre">:CREATE</span></code> to form PV names</p></td>
</tr>
<tr class="row-odd"><td><p>EPICS_PVA_TLS_KEYCHAIN</p></td>
<td colspan="2" rowspan="2"><p>{fully qualified path  to keychain file}</p>
<p>e.g. <code class="docutils literal notranslate"><span class="pre">~/.config/client.p12</span></code>,
<code class="docutils literal notranslate"><span class="pre">~/.config/server.p12</span></code></p>
</td>
<td rowspan="2"><p>This is the string that determines the fully qualified path
to the keychain file that contains the certificate,
and private keys used in the TLS handshake.
Note: If not specified then TLS is disabled</p></td>
</tr>
<tr class="row-even"><td><p>EPICS_PVAS_TLS_KEYCHAIN</p></td>
</tr>
<tr class="row-odd"><td><p>EPICS_PVA_TLS_KEYCHAIN
_PWD_FILE</p></td>
<td colspan="2" rowspan="2"><p>{fully qualified path to keychain password file}</p>
<p>e.g. <code class="docutils literal notranslate"><span class="pre">~/.config/client.pass</span></code>,
<code class="docutils literal notranslate"><span class="pre">~/.config/server.pass</span></code></p>
</td>
<td rowspan="2"><p>This is the string that determines the fully qualified path
to a file that contains the password that unlocks the
keychain file.  This is optional.  If not specified, the
keychain file contents will not be encrypted. It is not
recommended to not specify a password file.</p></td>
</tr>
<tr class="row-even"><td><p>EPICS_PVAS_TLS_KEYCHAIN
_PWD_FILE</p></td>
</tr>
<tr class="row-odd"><td rowspan="10"><p>EPICS_PVA_TLS_OPTIONS</p>
<p>Sets the TLS options
for clients and servers.
A string containing
key/value pairs
separated by commas,
tabs or newlines</p>
</td>
<td rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">client_cert</span></code></p>
<p>Determines whether client
certificates are required</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">optional</span></code> (default)</p></td>
<td><p>During TLS handshake require client certificate to be
presented</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">require</span></code></p></td>
<td><p>Don’t require client certificate to be presented.</p></td>
</tr>
<tr class="row-odd"><td rowspan="3"><p><code class="docutils literal notranslate"><span class="pre">on_expiration</span></code></p>
<p>Determines what to do when
an EPICS agent’s
certificate has expired,
and a new one can’t be
automatically provisioned</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">fallback-to-tcp</span></code>  (default)</p></td>
<td><p>For servers only tcp search requests will be responded to.
For clients then no client certificate will be presented
in the TLS handshake (but searches will still offer both tls
and tcp as supported protocols)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">shutdown</span></code></p></td>
<td><p>The process will exit gracefully.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">standby</span></code></p></td>
<td><p>Servers will not respond to any requests until a new
certificate is successfully provisioned.  It will keep
retrying the keychain file periodically.  When a valid
certificate is available it will continue as normal.</p>
<p>For a client standby has the same effect as shutdown.</p>
</td>
</tr>
<tr class="row-even"><td rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">on_no_cms</span></code></p>
<p>Determines what to do when
CMS is unavailable</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">fallback-to-tcp</span></code> (default)</p></td>
<td><p>If revocation status check is required but CMS cannot
degrade connections to tcp mode</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">throw</span></code></p></td>
<td><p>Otherwise throw an exception</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">no_revocation_check</span></code></p>
<p>Determines whether cert
status is monitored</p>
</td>
<td></td>
<td><p>This flag, if present, disables certificate revocation status
monitoring meaning that this certificate will not be able to
be revoked.
Default: revocation status monitoring is not disabled</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">no_stapling</span></code></p>
<p>Determines whether
stapling is enabled</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">yes</span></code>, <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>Servers won’t staple certificate status, clients won’t
request stapling information during TLS handshake</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">no</span></code>, <code class="docutils literal notranslate"><span class="pre">false</span></code>, <code class="docutils literal notranslate"><span class="pre">0</span></code> (default)</p></td>
<td><p>Don’t disable stapling</p></td>
</tr>
<tr class="row-odd"><td><p>EPICS_PVA_TLS_PORT</p></td>
<td colspan="2" rowspan="2"><p>{port number} default <code class="docutils literal notranslate"><span class="pre">5076</span></code></p>
<p>e.g. <code class="docutils literal notranslate"><span class="pre">8076</span></code></p>
</td>
<td rowspan="2"><p>This is a number that determines the port used for the Secure
PVAccess, either as the port on the Secure PVAccess server
for clients to connect to - PVA, or as the local port number
for Secure PVAccess servers to listen on - PVAS.</p></td>
</tr>
<tr class="row-even"><td><p>EPICS_PVAS_TLS_PORT</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>EPICS_PVAS_TLS_STOP
_IF_NO_CERT.</p></td>
<td colspan="2"><p><code class="docutils literal notranslate"><span class="pre">yes</span></code>, <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td rowspan="2"><p>For servers only. Stop if no certificate is provided.</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p><code class="docutils literal notranslate"><span class="pre">no</span></code>, <code class="docutils literal notranslate"><span class="pre">false</span></code>, <code class="docutils literal notranslate"><span class="pre">0</span></code> (default)</p></td>
</tr>
<tr class="row-odd"><td><p>SSLKEYLOGFILE</p></td>
<td colspan="2"><p>{fully qualified path to key log file}</p>
<p>e.g. <code class="docutils literal notranslate"><span class="pre">~/.config/keylog</span></code></p>
</td>
<td><p>This is the path to the SSL key log file that, in conjunction
with the build-time macro <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">PVXS_ENABLE_SSLKEYLOGFILE</span></code>,
controls where and whether we store the session key for TLS
sessions in a file.  If it is defined, then the code will
contain the calls to save the keys in the file specified
by this variable.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="api-configuration-options">
<span id="configuration"></span><h3>API Configuration Options<a class="headerlink" href="#api-configuration-options" title="Link to this heading">¶</a></h3>
<p>The following are new configuration options now available
in both the <a class="reference internal" href="server.html#_CPPv4N4pvxs6server6ConfigE" title="pvxs::server::Config"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::server::Config</span></code></a> and <a class="reference internal" href="client.html#_CPPv4N4pvxs6client6ConfigE" title="pvxs::client::Config"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::client::Config</span></code></a> classes,
via their public base <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon</span></code> class:</p>
<ul class="simple">
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::expiration_behaviour</span></code> - Set certificate expiration behavior</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_keychain_file</span></code> - Set keychain file path</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_keychain_pwd</span></code> - Set keychain file password</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_client_cert_required</span></code> - Control client certificate requirements</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_disable_stapling</span></code> - Disable certificate status stapling</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_disable_status_check</span></code> - Disable certificate status checking</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_disabled</span></code> - Disable TLS</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_port</span></code> - Set TLS port number</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::impl::ConfigCommon::tls_throw_if_cant_verify</span></code> - Control verification failure behavior</p></li>
</ul>
<p>Here are server-specific configuration options:</p>
<ul class="simple">
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::server::Config::tls_stop_if_no_cert</span></code> - Stop server if certificate unavailable</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::server::Config::tls_throw_if_no_cert</span></code> - Throw exception if certificate unavailable</p></li>
</ul>
</section>
<section id="api-additions-for-secure-pvaccess">
<h3>API Additions for Secure PVAccess<a class="headerlink" href="#api-additions-for-secure-pvaccess" title="Link to this heading">¶</a></h3>
<section id="runtime-reconfiguration">
<h4>Runtime Reconfiguration<a class="headerlink" href="#runtime-reconfiguration" title="Link to this heading">¶</a></h4>
<p>Allows runtime reconfiguration of a TLS connection.  It does this by dropping all TLS connections and
then re-initialising them using the given configuration.  This means checking if the certificates
and keys exist, loading and verifying them, checking for status and status of peers, etc.</p>
<ul class="simple">
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::client::Context::reconfigure</span></code> and</p></li>
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::server::Server::reconfigure</span></code></p></li>
</ul>
<p>Example of TLS configuration reconfiguration:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initial client setup with certificate</span>
<span class="k">auto</span><span class="w"> </span><span class="n">cli_conf</span><span class="p">(</span><span class="n">serv</span><span class="p">.</span><span class="n">clientConfig</span><span class="p">());</span>
<span class="n">cli_conf</span><span class="p">.</span><span class="n">tls_keychain_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;client1.p12&quot;</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">cli</span><span class="p">(</span><span class="n">cli_conf</span><span class="p">.</span><span class="n">build</span><span class="p">());</span>

<span class="c1">// Later reconfiguration with new certificate</span>
<span class="n">cli_conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cli</span><span class="p">.</span><span class="n">config</span><span class="p">();</span>
<span class="n">cli_conf</span><span class="p">.</span><span class="n">tls_keychain_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;client2.p12&quot;</span><span class="p">;</span>
<span class="n">cli_conf</span><span class="p">.</span><span class="n">tls_keychain_pwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pwd&quot;</span><span class="p">;</span>
<span class="n">cli</span><span class="p">.</span><span class="n">reconfigure</span><span class="p">(</span><span class="n">cli_conf</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="wildcard-pv-support">
<h4>Wildcard PV Support<a class="headerlink" href="#wildcard-pv-support" title="Link to this heading">¶</a></h4>
<p>This addition is based on the Wildcard PV support included in epics-base since version 3.  It
extends this support to pvxs allowing PVs to be specified as wildcard patterns.  We use this
to provide individualised PVs for each certificate’s status management.</p>
<ul class="simple">
<li><p><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">pvxs::server::SharedWildcardPV</span></code></p></li>
</ul>
<p>Example of support for pattern-matched PV names:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define a server that responds to any SEARCH request with WILDCARD:PV:&lt;4-characters&gt;:&lt;any-string&gt;</span>
<span class="c1">// It will extract the 4-character part of the PV name as the `id` and</span>
<span class="c1">// the last string as the `name`</span>

<span class="n">SharedWildcardPV</span><span class="w"> </span><span class="nf">wildcard_pv</span><span class="p">(</span><span class="n">SharedWildcardPV</span><span class="o">::</span><span class="n">buildMailbox</span><span class="p">());</span>
<span class="n">wildcard_pv</span><span class="p">.</span><span class="n">onFirstConnect</span><span class="p">([](</span><span class="n">SharedWildcardPV</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pv</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pv_name</span><span class="p">,</span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Extract id and name from parameters</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*++</span><span class="n">it</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Process and post value</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pv</span><span class="p">.</span><span class="n">isOpen</span><span class="p">(</span><span class="n">pv_name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pv</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pv</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
<span class="n">wildcard_pv</span><span class="p">.</span><span class="n">onLastDisconnect</span><span class="p">([](</span><span class="n">SharedWildcardPV</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pv</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pv_name</span><span class="p">,</span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pv</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">pv_name</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Add wildcard PV to server</span>
<span class="n">serv</span><span class="p">.</span><span class="n">addPV</span><span class="p">(</span><span class="s">&quot;WILDCARD:PV:????:*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wildcard_pv</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="protocol-operation">
<span id="id3"></span><h2>Protocol Operation<a class="headerlink" href="#protocol-operation" title="Link to this heading">¶</a></h2>
<section id="connection-establishment">
<span id="id4"></span><h3>Connection Establishment<a class="headerlink" href="#connection-establishment" title="Link to this heading">¶</a></h3>
<p>Connections are established using TLS if at least the server side is configured for TLS.</p>
<p>Prior to the TLS handshake:</p>
<ul class="simple">
<li><p>Certificates are loaded and validated</p></li>
<li><p>Certificate authority trust is verified all the way down the chain</p></li>
<li><p>Both sides subscribe to certificate status where configured for their own certificate and all those in the chain</p></li>
<li><p>All certificate statues are cached</p></li>
</ul>
<p>During the TLS handshake:</p>
<ul class="simple">
<li><p>Certificates are exchanged</p></li>
<li><p>Servers staple cached certificate status in handshake</p></li>
<li><p>Both sides validate and verify their peer certificate against trusted root certificates</p></li>
</ul>
<p>After the TLS handshake:</p>
<ul class="simple">
<li><p>Both sides subscribe to peer certificate status where configured</p></li>
<li><p>Clients may use stapled server certificate status</p></li>
</ul>
</section>
<section id="connection-types">
<h3>Connection Types<a class="headerlink" href="#connection-types" title="Link to this heading">¶</a></h3>
<p>There are three types of possible connections</p>
<ul class="simple">
<li><p>tcp / tcp : TCP only connection, legacy <code class="docutils literal notranslate"><span class="pre">ca</span></code></p></li>
<li><p>tcp / tls : server-only authenticated TLS</p></li>
<li><p>tls / tls : mutually authenticated TLS</p></li>
</ul>
<p>If an EPICS agent finds a certificate, trust anchor, and private key at the location specified by <code class="docutils literal notranslate"><span class="pre">EPICS_PVA_TLS_KEYCHAIN</span></code> then it will use that certificate for the handshake.
This includes the default location that the variable points to even if its is not set.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">~/.config/pva/1.3/client.p12</span></code> - for clients</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">~/.config/pva/1.3/server.p12</span></code> - for servers</p></li>
</ul>
<p>For a server-only authenticated TLS connection two things are required:</p>
<ul class="simple">
<li><p>The server must be configured to allow server-only authenticated TLS connections by setting the <code class="docutils literal notranslate"><span class="pre">EPICS_PVA_TLS_OPTIONS</span></code> option <code class="docutils literal notranslate"><span class="pre">client_cert</span></code> to <code class="docutils literal notranslate"><span class="pre">optional</span></code></p></li>
<li><p>The client must have a keychain file containing a trust anchor alone, at the location specified by <code class="docutils literal notranslate"><span class="pre">EPICS_PVA_TLS_KEYCHAIN</span></code>.
- The p12 file can be created using <code class="docutils literal notranslate"><span class="pre">authnstd</span></code> with the <code class="docutils literal notranslate"><span class="pre">-t</span></code> option.</p></li>
</ul>
</section>
<section id="state-machines">
<span id="id5"></span><h3>State Machines<a class="headerlink" href="#state-machines" title="Link to this heading">¶</a></h3>
<p><em>Server TLS Context State:</em></p>
<p>The state transitions based on:</p>
<ul class="simple">
<li><p>Certificate validity and configuration</p></li>
<li><p>Certificate status monitoring results</p></li>
<li><p><a class="reference internal" href="#configuration"><span class="std std-ref">API Configuration Options</span></a> options (e.g., <code class="docutils literal notranslate"><span class="pre">EPICS_PVAS_TLS_STOP_IF_NO_CERT</span></code>)</p></li>
</ul>
<p>States:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Init</span></code>: Initial state, loads and validates certificates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TcpReady</span></code>: Responds to TCP protocol requests when certificates are valid</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsReady</span></code>: Responds to both TCP and TLS protocol requests</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DegradedMode</span></code>: Fallback state for invalid certificates, missing TLS configuration, or revoked certificates</p></li>
</ul>
<img alt="SPVA Server TLS Context State Machine" class="align-center" src="_images/spva_server_tls_context.png" />
<p><em>Client TLS Context State:</em></p>
<p>Similar to server but with key differences:</p>
<ul class="simple">
<li><p>Never exits on TLS configuration issues</p></li>
<li><p>Trust Anchor validation affects initial state transitions</p></li>
</ul>
<p>States:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Init</span></code>: Initial state, loads and validates certificates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TcpReady</span></code>: Responds to TCP protocol requests when certificates are valid</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsReady</span></code>: Responds to both TCP and TLS protocol requests</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DegradedMode</span></code>: Fallback state for invalid certificates, missing TLS configuration, or revoked certificates</p></li>
</ul>
<img alt="SPVA Client TLS Context State Machine" class="align-center" src="_images/spva_client_tls_context.png" />
<p><em>Peer Certificate Status State Machine:</em></p>
<p>Shows the possible states and transitions for a peer’s certificate status.
Applies equally to EPICS Clients, and Servers.</p>
<p>States:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UNKNOWN</span></code>: Initial state before status is determined</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GOOD</span></code>: Certificate is valid and trusted</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">GOOD</span></code>: Certificate is not currently trusted</p></li>
</ul>
<p>Pseudo States:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">STALE</span></code>: Status information is outdated.  State transitions immediately to UNKNOWN</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">REVOKED</span></code>: Certificate has been permanently revoked. No way back from this status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXPIRED</span></code>: Certificate has passed its validity period. No way back from this status</p></li>
</ul>
<p>State transitions occur based on:</p>
<ul class="simple">
<li><dl class="simple">
<dt>Subscribed-to status updates from PVACMS</dt><dd><ul>
<li><p>Certificate expiration</p></li>
<li><p>Certificate revocation</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>PVACMS availability</p></li>
</ul>
<img alt="SPVA Peer Certificate Status State Machine" class="align-center" src="_images/spva_peer_certificate_status.png" />
<section id="pvaccess-sequence-diagram">
<span id="tls-handshake"></span><h4>PVAccess Sequence Diagram<a class="headerlink" href="#pvaccess-sequence-diagram" title="Link to this heading">¶</a></h4>
<p>The following diagram shows the PVAccess connection establishment sequence:</p>
<a class="reference internal image-reference" href="_images/pva_seq.png"><img alt="PVA Sequence Diagram" class="align-center" src="_images/pva_seq.png" style="width: 300px;" />
</a>
</section>
<section id="secure-pvaccess-sequence-diagram">
<h4>Secure PVAccess Sequence Diagram<a class="headerlink" href="#secure-pvaccess-sequence-diagram" title="Link to this heading">¶</a></h4>
<p>The following diagram shows how the Secure PVAccess protocol establishes a secure connection between an EPICS client and server:</p>
<img alt="SPVA Sequence Diagram" class="align-center" src="_images/spva_simple_seq.png" />
<p>Click for a detailed diagram <a class="reference external" href="_images/h_spva_seq.png">with</a>
or <a class="reference external" href="_images/h_tls_seq.png">without</a> certificate status monitoring</p>
<ol class="arabic simple">
<li><p>Each agent uses an <code class="docutils literal notranslate"><span class="pre">X.509</span></code> certificate for peer authentication</p>
<ul class="simple">
<li><p>Certificate is verified against own trust anchor (stored in same keychain file as certificate)</p></li>
<li><p>Multiple certificates may be verified in the chain to trust anchor</p></li>
<li><p>Verification checks the signature, expiration, and usage flags</p></li>
<li><p>If certificate is configured for status monitoring, subscribes to status updates from PVACMS</p></li>
<li><p>Certificate status is verified and cached</p></li>
</ul>
</li>
<li><p>During handshake:</p>
<ul class="simple">
<li><p>Certificates are exchanged</p></li>
<li><p>Both sides verify peer certificates against their own trust anchor</p></li>
<li><p>Multiple peer certificates may be verified in the chain to own trust anchor</p></li>
<li><p>Verification checks the signature, expiration, and usage flags</p></li>
<li><p>If peer certificate is configured for status monitoring, subscribes to status updates from PVACMS</p></li>
<li><p>Peer certificate status is verified and cached</p></li>
<li><p>Server may staple its own certificate status in handshake</p></li>
<li><p>Client may use stapled status immediately, instead of waiting for status monitoring results</p></li>
</ul>
</li>
<li><p>SPVA certificates may include status monitoring extension requiring:</p>
<ul class="simple">
<li><p>Subscription to certificate status from issuing Certificate Authority’s service (<a class="reference internal" href="spvacerts.html#pvacms"><span class="std std-ref">PVACMS</span></a>)</p></li>
<li><p>Receipt of <code class="docutils literal notranslate"><span class="pre">GOOD</span></code> status before trust</p></li>
</ul>
</li>
<li><p>Agents subscribe to:</p>
<ul class="simple">
<li><p>Own certificate status</p></li>
<li><p>Peer’s certificate status</p></li>
</ul>
</li>
<li><p>Servers cache and staple certificate status in handshake</p></li>
</ol>
</section>
</section>
<section id="certificate-status-verification">
<span id="status-verification"></span><h3>Certificate Status Verification<a class="headerlink" href="#certificate-status-verification" title="Link to this heading">¶</a></h3>
<p>Certificate Status received from the PVACMS for a certificate returns a <code class="docutils literal notranslate"><span class="pre">GOOD</span></code> status
if, and only if,</p>
<ul class="simple">
<li><p>the certificate status is GOOD and</p></li>
<li><p>so is that of its trust anchor certificate chain</p></li>
<li><p>all the way back to the root certificate</p></li>
</ul>
<p>In this way agents need monitor only their own entity certificate and that of their peer.</p>
<p>Certificate status verification occurs at several points:</p>
<ol class="arabic simple">
<li><p>Initial Connection</p>
<ul class="simple">
<li><p>Certificates are verified during TLS handshake</p></li>
<li><p>Both peers verify against a trusted root certificate that they have loaded from their own keychain file</p></li>
<li><p>Basic checks include:</p>
<ul>
<li><p>Signature validation</p></li>
<li><p>Expiration dates</p></li>
<li><p>Usage flags</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Runtime Monitoring</p>
<ul class="simple">
<li><p>EPICS agents subscribe to:</p>
<ul>
<li><p>Their own certificate status</p></li>
<li><p>Peer entity certificate status</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Status Response Handling</p>
<ul class="simple">
<li><p>If status not received:</p>
<ul>
<li><p>Search requests are ignored</p></li>
<li><p>Client retries later</p></li>
</ul>
</li>
<li><p>If status not <code class="docutils literal notranslate"><span class="pre">GOOD</span></code>:</p>
<ul>
<li><p>Server offers only TCP protocol</p></li>
<li><p>Client fails connection validation</p></li>
</ul>
</li>
<li><p>If status <code class="docutils literal notranslate"><span class="pre">GOOD</span></code>:</p>
<ul>
<li><p>Server offers both TCP and TLS</p></li>
<li><p>Connection proceeds normally</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Optimization</p>
<ul class="simple">
<li><p>Servers cache status for stapling</p></li>
<li><p>Clients can use stapled status</p></li>
<li><p>Reduces initial <a class="reference internal" href="spvacerts.html#pvacms"><span class="std std-ref">PVACMS</span></a> requests</p></li>
</ul>
</li>
</ol>
</section>
<section id="status-caching">
<span id="id6"></span><h3>Status Caching<a class="headerlink" href="#status-caching" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Agents subscribe to peer certificate status</p></li>
<li><p>Status transitions trigger connection status re-evaluation</p></li>
<li><p>Cached status are reused within validity period to reduce <a class="reference internal" href="spvacerts.html#pvacms"><span class="std std-ref">PVACMS</span></a> requests</p></li>
<li><p>Servers staple cached status in handshake</p></li>
<li><p>Clients may skip initial <a class="reference internal" href="spvacerts.html#pvacms"><span class="std std-ref">PVACMS</span></a> request using stapled status</p></li>
</ul>
</section>
<section id="beacons">
<h3>Beacons<a class="headerlink" href="#beacons" title="Link to this heading">¶</a></h3>
<p>PVAccess Beacon Messages have not been upgraded to TLS support. Important considerations:</p>
<ol class="arabic simple">
<li><p>Historical Use:
- Previously used to trigger resend of unanswered Search Messages
- This practice is now discouraged
- Other methods should be used to determine server status</p></li>
<li><p>Current Behavior:
- Servers broadcast on any configured port
- Clients should not use ports directly
- Use only as server availability indicator</p></li>
<li><p>Security Implications:
- Beacons remain unencrypted
- Do not contain sensitive information
- Cannot be used for secure discovery</p></li>
</ol>
</section>
</section>
<section id="protocol-debugging">
<span id="id7"></span><h2>Protocol Debugging<a class="headerlink" href="#protocol-debugging" title="Link to this heading">¶</a></h2>
<section id="tls-packet-inspection">
<h3>TLS Packet Inspection<a class="headerlink" href="#tls-packet-inspection" title="Link to this heading">¶</a></h3>
<p>For detailed TLS traffic analysis:</p>
<ol class="arabic simple">
<li><p>Enable key logging at build time:</p>
<ul class="simple">
<li><p>Set PVXS_ENABLE_SSLKEYLOGFILE during compilation</p></li>
</ul>
</li>
<li><p>Configure runtime logging:</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">SSLKEYLOGFILE</span><span class="o">=</span>/tmp/sslkeylog.log
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Configure Wireshark:</p>
<ul class="simple">
<li><p>Edit &gt; Preferences &gt; Protocols &gt; TLS</p></li>
<li><p>Set “(Pre)-Master-Secret log filename” to match SSLKEYLOGFILE path</p></li>
<li><p>TLS traffic will now be decrypted in Wireshark</p></li>
</ul>
</li>
</ol>
</section>
<section id="debug-logging">
<h3>Debug Logging<a class="headerlink" href="#debug-logging" title="Link to this heading">¶</a></h3>
<p>Enable detailed PVXS debug logging:</p>
<ol class="arabic simple">
<li><p>Environment variable method:</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PVXS_LOG</span><span class="o">=</span><span class="s2">&quot;pvxs.stapling*=DEBUG&quot;</span>
</pre></div>
</div>
<p>New Debug Categories:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.certs.auth</span></code>          - Authenticators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.cfg</span></code>            - Authn configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.cms</span></code>            - CMS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.jwt</span></code>            - JWT Authenticator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.krb</span></code>            - Kerberos Authenticator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.mon</span></code>            - Certificate Status Monitoring</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.stat</span></code>           - Certificate Status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.std</span></code>            - Standard Authenticator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.auth.tool</span></code>           - Certificate Management Tools (<code class="docutils literal notranslate"><span class="pre">pvacert</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.certs.status</span></code>        - Certificate Status Management</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.ossl.init</span></code>           - TLS initialization</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.ossl.io</span></code>             - TLS I/O</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvxs.stapling</span></code>            - OCSP stapling</p></li>
</ul>
</section>
</section>
<section id="network-deployment">
<span id="id8"></span><h2>Network Deployment<a class="headerlink" href="#network-deployment" title="Link to this heading">¶</a></h2>
<section id="deployment-patterns">
<h3>Deployment Patterns<a class="headerlink" href="#deployment-patterns" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Standard Network Deployment</p>
<ul class="simple">
<li><p>Agents run on networked hosts with local storage</p></li>
<li><p>Certificates stored in local protected directories</p></li>
<li><p>Standard TLS configuration applies</p></li>
</ul>
</li>
<li><p>Diskless Network Deployment</p>
<ul class="simple">
<li><p>Agents run on hosts without local storage</p></li>
<li><p>Certificates stored on network-mounted storage</p></li>
<li><p>Special considerations for certificate protection</p></li>
</ul>
</li>
<li><p>Hybrid Deployment</p>
<ul class="simple">
<li><p>Mix of standard and diskless nodes</p></li>
<li><p>Common trust anchor required</p></li>
<li><p>Consistent <a class="reference internal" href="spvacerts.html#certificate-management"><span class="std std-ref"> Cert Management</span></a> across node types</p></li>
</ul>
</li>
</ol>
</section>
<section id="keychain-file-storage">
<h3>Keychain-File Storage<a class="headerlink" href="#keychain-file-storage" title="Link to this heading">¶</a></h3>
<p>Standard Nodes:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://specifications.freedesktop.org/basedir-spec/latest/">XDG_CONFIG_HOME</a> standard is used by default to locate keychain files for clients and servers</p>
<ul>
<li><p>default, if not set, is <code class="docutils literal notranslate"><span class="pre">~/.config</span></code></p></li>
<li><p>we append <code class="docutils literal notranslate"><span class="pre">/pva/1.3/</span></code> to make the full path default to <code class="docutils literal notranslate"><span class="pre">~/.config/pva/1.3/</span></code></p></li>
<li><p>client keychain files are, by default, <code class="docutils literal notranslate"><span class="pre">client.p12</span></code></p></li>
<li><p>server keychain files are, by default, <code class="docutils literal notranslate"><span class="pre">server.p12</span></code></p></li>
</ul>
</li>
<li><p>Store certificates in local protected directory</p>
<ul>
<li><p>keychain files contain
- the certificate
- the private key
- the certificate authority chain including the root certificate</p></li>
<li><p>the files are protected with <code class="docutils literal notranslate"><span class="pre">400</span></code> so that only the owner can read</p></li>
</ul>
</li>
<li><p>Automatic reconfiguration on certificate updates</p></li>
</ul>
<p>Diskless Nodes:</p>
<ul class="simple">
<li><p>Use network-mounted storage (NFS, SMB/CIFS, AFP)</p></li>
<li><p>Protected certificate storage location</p></li>
<li><p>Optional password protection via diskless server</p></li>
</ul>
</section>
<section id="trust-establishment">
<h3>Trust Establishment<a class="headerlink" href="#trust-establishment" title="Link to this heading">¶</a></h3>
<ol class="arabic">
<li><p>Trust Anchor Distribution:</p>
<ul class="simple">
<li><p>Administrators must distribute PKCS#12 files containing the Root Certificate Authority certificate to all clients</p></li>
<li><p>These files must be stored at the location pointed to by EPICS_PVA_TLS_KEYCHAIN or equivalent</p></li>
<li><p>These files are replaced with any new certificates that are generated for the user but
the trust anchor certificate is preserved</p></li>
<li><p>Use of publicly signed trust anchor certificates is not supported at present</p></li>
</ul>
</li>
<li><p>Trust Anchor Distribution with Authenticators:</p>
<ul>
<li><p>The trust anchor certificate is delivered with the entity certificate.</p></li>
<li><p>Users must verify that the issuer of the certificate matches the Root Certificate Authority they are expecting.</p></li>
<li><p>To control the selection of PVACMS service and thus the trust anchor certificate, users verify their PVAccess configuration.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">EPICS_PVA_ADDR_LIST</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EPICS_PVA_AUTO_ADDR_LIST</span></code></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Consistent across all deployment types</p></li>
</ul>
</li>
<li><p>Getting Trust Anchor from PVACMS</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">authnstd</span></code> to get the trust anchor certificate from PVACMS</p></li>
<li><p>The p12 file created can be used by a client to create a server-only authenticated TLS connection</p></li>
</ul>
</li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the trust anchor certificate from PVACMS and save to the location specified by ``EPICS_PVA_TLS_KEYCHAIN``</span>
authnstd<span class="w"> </span>--trust-anchor

<span class="c1"># Get the trust anchor certificate from PVACMS and save to the location specified by ``EPICS_PVAS_TLS_KEYCHAIN``</span>
authnstd<span class="w"> </span>-u<span class="w"> </span>server<span class="w"> </span>-a
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Certificate Authority = Trust Anchor</p>
<ul class="simple">
<li><p><a class="reference internal" href="spvacerts.html#pvacms"><span class="std std-ref">PVACMS</span></a> serves as site Certificate Authority</p></li>
<li><p>Common trust anchor for all nodes</p></li>
<li><p>Handles certificate lifecycle management</p></li>
</ul>
</li>
</ol>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PVXS</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="netconfig.html">PVA Network Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="spvaqstart.html"><i class="material-symbols-outlined" style="vertical-align: middle;">developer_guide</i> Quick Start PVXS</a></li>
<li class="toctree-l1"><a class="reference internal" href="spvaqstartstd.html"><i class="material-symbols-outlined" style="vertical-align: middle;">developer_guide</i> Quick Start Std</a></li>
<li class="toctree-l1"><a class="reference internal" href="spvaqstartkrb.html"><i class="material-symbols-outlined" style="vertical-align: middle;">developer_guide</i> Quick Start KRB</a></li>
<li class="toctree-l1"><a class="reference internal" href="spvaqstartldap.html"><i class="material-symbols-outlined" style="vertical-align: middle;">developer_guide</i> Quick Start LDAP</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#"><i class="material-symbols-outlined" style="vertical-align: middle;">security</i> Secure PVAccess</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#transport-layer-security">Transport Layer Security</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-keychain-file-formats-encodings-and-file-types">Supported Keychain-File Formats, Encodings and File Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unsupported-certificate-formats-encodings-and-file-types">Unsupported Certificate Formats, Encodings and File Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tls-encapsulation-of-the-pvaccess-protocol">TLS encapsulation of the PVAccess protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-configuration-options">API Configuration Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-additions-for-secure-pvaccess">API Additions for Secure PVAccess</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#protocol-operation">Protocol Operation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#connection-establishment">Connection Establishment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-types">Connection Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#state-machines">State Machines</a></li>
<li class="toctree-l3"><a class="reference internal" href="#certificate-status-verification">Certificate Status Verification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#status-caching">Status Caching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#beacons">Beacons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#protocol-debugging">Protocol Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tls-packet-inspection">TLS Packet Inspection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug-logging">Debug Logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#network-deployment">Network Deployment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deployment-patterns">Deployment Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keychain-file-storage">Keychain-File Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trust-establishment">Trust Establishment</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="spvaauth.html"><i class="material-symbols-outlined" style="vertical-align: middle;">security</i> AuthN &amp; AuthZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="spvacerts.html"><i class="material-symbols-outlined" style="vertical-align: middle;">security</i> Cert Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building from Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html#including-pvxs-in-your-application">Including PVXS in your application</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="value.html">Value Container API</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Client API</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Server API</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc.html">IOC Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc.html#qsrv-2">QSRV 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="util.html">Misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="details.html">Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="spvaglossary.html"><i class="material-symbols-outlined" style="vertical-align: middle;">security</i> SPVA Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasenotes.html">Release Notes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="spvaqstartldap.html" title="previous chapter"><i class="material-symbols-outlined" style="vertical-align: middle;">developer_guide</i> Quick Start LDAP</a></li>
      <li>Next: <a href="spvaauth.html" title="next chapter"><i class="material-symbols-outlined" style="vertical-align: middle;">security</i> AuthN &amp; AuthZ</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025 Michael Davidsaver, George McIntyre, Osprey DCS LLC, and SLAC.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/spva.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>